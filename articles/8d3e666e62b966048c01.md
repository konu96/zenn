---
title: "Vue3 ã® reactive vs ref"
emoji: "ğŸŒŠ"
type: "tech"
topics: ["Vue.js", "Vue3"]
published: true
---

## æ¦‚è¦

æœ€è¿‘ [this vs that](https://thisthat.dev/) ã‚’èª­ã‚“ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç†è§£ã‚’æ·±ã‚ã¦ã„ã¾ã™.  TypeScript ã®ã€Œinterface vs typeã€ã‚„ CSS ã®ã€Œdisplay: none vs [hidden]ã€ã¯ã€ã©ã¡ã‚‰ãŒè‰¯ã„ã®ã‹åˆå­¦è€…ã«ã¯é›£ã—ã„ã§ã™ã‚ˆã­ğŸ’¦.
ãŸã ã¨ã¦ã‚‚å‹‰å¼·ã«ãªã‚‹ä¸€æ–¹ã€React ã®é …ç›®ã¯ã‚ã‚‹ã®ã« Vue.js ã®é …ç›®ãŒãªã„ã§ã™.

ãã“ã§ã€ã“ã®è¨˜äº‹ã§ã¯ Vue.js ã® this vs that ã¨ã—ã¦ reactive ã¨ ref ã«ã¤ã„ã¦é•ã„ã‚’ã¾ã¨ã‚ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™.

## Vue3 ã®ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã¤ã„ã¦
Vue3 ã®ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯ã€`Proxy` ã‚’ä½¿ã£ã¦å®Ÿç¾ã—ã¦ã„ã¾ã™.`Proxy` ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚ã‚‹å¤‰æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ãã‚Œã«ä¾å­˜ã™ã‚‹å¤‰æ•°ã‚‚å†è¨ˆç®—ã•ã‚Œã¾ã™. 

```
// ä½¿ã„æ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
const data = new Proxy({
  value: 1
}, {
    set: function(obj, prop, newValue) {
        obj[prop] = newValue;
        func();
    }
});

let value = 2 * data.value
const func = () => {
    value = 2 * data.value
}

console.log(value); // 2

data.value = 4;

console.log(value); // 8
```

ã“ã“ã§å¤§äº‹ãªã®ã¯ã€ `Proxy` ã«æ¸¡ã™ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ãŸã„å¤‰æ•°ã‚’ **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** ã«ã—ã¦ã„ã‚‹ç‚¹ã§ã™.

FYI: Vue2 ã§ã¯ã€`Proxy` ã§ã¯ãªã `Object.defineProperty` ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸ. `Object.defineProperty` ã¨ `Proxy` ã¯é•ã†è¨˜äº‹ã§æ›¸ã“ã†ã¨æ€ã„ã¾ã™.

## reactive vs ref
çµè«–ã€ **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹å ´åˆã¯ `reactive`ã€ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã‚’ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹å ´åˆã¯ã€`ref` ã‚’ä½¿ãˆã°è‰¯ã„ã§ã™.**

ä»¥ä¸‹ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§å®Ÿè£…ã‚’è¿½ã„ãªãŒã‚‰èª¬æ˜ã—ã¾ã™. ã¾ãšã€æœ€åˆã« `reacrive` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†.

```ts
export function reactive(target: object) {
  // çœç•¥ã€€
  return createReactiveObject(
    target,
    false,
    mutableHandlers,
    mutableCollectionHandlers
  )
}

function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>
) {
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }
    return target
  }

  // çœç•¥

  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
  )
  proxyMap.set(target, proxy)
  return proxy
}
```

åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’çœç•¥ã—ã¦ã„ã¾ã™ãŒå¤§é›‘æŠŠã«ä»¥ä¸‹ã®æµã‚Œã§å‡¦ç†ã—ã¾ã™.

1. `createReactiveObject` ãŒå‘¼ã°ã‚Œã‚‹
2. å¼•æ•°ã® `target` ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹
3. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ `Proxy` ã®å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹
4. `Proxy` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹

æ¬¡ã« `ref` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†.

```ts
export function ref(value?: unknown) {
  return createRef(value)
}

function createRef(rawValue: unknown, shallow = false) {
  if (isRef(rawValue)) {
    return rawValue
  }
  return new RefImpl(rawValue, shallow)
}

class RefImpl<T> {
  private _value: T
  public readonly __v_isRef = true

  constructor(private _rawValue: T, public readonly _shallow = false) {
    this._value = _shallow ? _rawValue : convert(_rawValue)
  }

  get value() {
    track(toRaw(this), TrackOpTypes.GET, 'value')
    return this._value
  }

  set value(newVal) {
    if (hasChanged(toRaw(newVal), this._rawValue)) {
      this._rawValue = newVal
      this._value = this._shallow ? newVal : convert(newVal)
      trigger(toRaw(this), TriggerOpTypes.SET, 'value', newVal)
    }
  }
}

const convert = <T extends unknown>(val: T): T => isObject(val) ? reactive(val) : val
```

1. `createRef` ã‚’å‘¼ã¶
2. æ¸¡ã£ã¦ããŸå€¤ã‚’å…ƒã« `RefImpl` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹
3. `RefImpl` ã§ã¯ `_value` ã‹ã‚‰ `value` ã® `get`, `set` ã‚’å®šç¾©ã—ã¦ã„ã‚‹
4. `RefImpl` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹

æœ¬å½“ã¯ `track` ã‚„ `trigger` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ã€ã©ã®ã‚ˆã†ã«ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‡¦ç†ã‚’æœ€é©åŒ–ã—ã¦ã„ã‚‹ã‹è¦‹ã‚‹ã¹ãã§ã™ãŒè¨˜äº‹ãŒé•·ããªã‚‹ã®ã§çœç•¥ã—ã¾ã™.

æ•´ç†ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™.

| reactive | ref |
| :------: | :-: |
| å€¤ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ `Proxy` å‹ã«ã—ã¦è¿”ã™ | å€¤ã‚’å…ƒã« `RefImpl` å‹ã«ã—ã¦è¿”ã™. `RefImpl` ã§ã¯ `value` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã€ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚‹ |

ã“ã®ã‚ˆã†ãªç‰¹å¾´ã®ãŸã‚ã€æœ€åˆã«æ›¸ã„ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ `reactive`ã€ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ãªã‚‰ `ref` ãŒè‰¯ã„ã§ã™.
`ref` ã«ã¯ä¸€ã¤æ³¨æ„ç‚¹ãŒã‚ã‚Š `<script>` ã‚¿ã‚°å†…ã§ä½¿ã†å ´åˆã¯ã€`value` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„.

```ts
const data = ref(0);

console.log(data.value); // 0
```

## å‚è€ƒ
- https://dev.to/jinjiang/understanding-reactivity-in-vue-3-0-1jni
- https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Proxy
- https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty